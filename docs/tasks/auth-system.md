# 사용자 인증 시스템 구현

## 개요
색각 이상자를 위한 패션 커뮤니티 'Palette'의 사용자 인증 시스템을 구현합니다.

## 목표
- 안전하고 효율적인 사용자 인증 시스템 구축
- 개인화된 사용자 경험 제공
- 사용자 데이터 보호

## 기능 요구사항

### 1. 회원가입 [구현 중]
- 필수 입력 정보
  - 이메일 (유효성 검사)
  - 비밀번호 (8자 이상, 특수문자 포함)
  - 닉네임 (2-20자)
  - 색각 유형 (정상, 제1색맹, 제2색맹, 제3색맹, 색약)
- 선택 입력 정보
  - 프로필 이미지
  - 자기소개
  - 선택 입력 정보 (소셜 가입 시 온보딩 페이지에서 닉네임 수정 및 자기소개 입력 가능)
  -  - 프로필 이미지
  -  - 자기소개 (소셜 가입 시 온보딩에서 입력)
- 이메일 인증 시스템 [수정 필요]
  - 인증 메일 발송 [완료]
  - 인증 링크 처리 [완료]
  - 인증 상태 관리 [버그: 401 에러 발생 중]
    - 회원가입 후 이메일 인증 페이지 이동은 정상
    - 인증 상태 체크 시 401 에러 발생 문제 해결 필요

### 2. 로그인 [구현 완료]
- 이메일/비밀번호 로그인
- JWT 토큰 기반 인증
- 로그인 상태 유지 옵션
- 토큰 자동 갱신

### 3. 사용자 프로필 [진행 중]
- 프로필 조회 [MyPage 일부 구현]
- 프로필 수정 [SettingsPage 일부 구현]
- 비밀번호 변경 [SettingsPage 일부 구현]

### 4. 보안 [구현 완료]
- 비밀번호 암호화 (bcrypt)
- JWT 토큰 관리
- XSS, CSRF 방어

### 5. 소셜 로그인 [개선 완료]
- **Google 로그인 [1차 구현 완료, 추가 개선 검토 중]**
  - 신규 사용자 Google 가입 시:
    - Google 계정 정보(이메일, 이름)를 기반으로 사용자 생성.
    - `isNewUserResponse: true` 반환, 프론트엔드에서 `/social-onboarding` 페이지로 리디렉션하여 닉네임, 자기소개 입력 유도.
  - 기존 사용자 Google 로그인:
    - `isNewUserResponse: false` 반환, 메인 페이지로 리디렉션.
  - 계정 연동:
    - 동일 이메일의 'email' 프로바이더 계정 존재 시: `EMAIL_ACCOUNT_EXISTS_NEEDS_MANUAL_LINK` 에러 반환. (수동 연동 필요)
    - 동일 이메일의 'kakao' 프로바이더 계정 존재 시: Google 계정으로 정보 업데이트 및 연동 (Google 우선).
- **Kakao 로그인 [1차 구현 완료 및 이메일 미제공 처리 완료]**
  - 신규 사용자 Kakao 가입 시:
    - Kakao 계정 정보(이메일, 닉네임, 프로필 이미지)를 기반으로 사용자 생성.
    - **Kakao 계정에 이메일 정보가 없는 경우 (처리 완료):**
      - `POST /api/auth/kakao` (intent: signup)는 `errorCode: 'ACCOUNT_NOT_FOUND_NO_EMAIL'` 및 `tempKakaoProfile` 반환.
      - 프론트엔드는 `/social-email-request`로 리디렉션하여 사용자로부터 이메일 입력받음.
      - `POST /api/auth/kakao/complete-signup` API를 통해 최종 가입 처리.
    - `isNewUserResponse: true` 반환, 프론트엔드에서 `/social-onboarding` 페이지로 리디렉션하여 닉네임 수정, 자기소개 입력 유도.
  - 기존 사용자 Kakao 로그인:
    - `isNewUserResponse: false` 반환, 메인 페이지로 리디렉션.
  - 계정 연동:
    - 동일 이메일의 'email' 프로바이더 계정 존재 시: `EMAIL_ACCOUNT_EXISTS_NEEDS_MANUAL_LINK` 에러 반환. (수동 연동 필요)
    - 동일 이메일의 'google' 프로바이더 계정 존재 시: Kakao 계정으로 정보 업데이트 및 연동 (Kakao 우선).

### 6. 회원 탈퇴 [신규/1차 구현 완료]
- **요청**: 사용자는 "계정 설정" 페이지를 통해 회원 탈퇴를 요청할 수 있습니다.
- **이메일 가입 사용자**:
  - 탈퇴 시 현재 비밀번호를 입력하여 본인 인증을 거쳐야 합니다.
- **소셜 로그인 사용자**:
  - 별도의 비밀번호 확인 없이 탈퇴를 진행할 수 있습니다.
- **카카오 계정 연동 해제**:
  - 카카오로 가입한 사용자의 경우, 탈퇴 처리 시 서버에서 카카오 어드민 키를 사용하여 해당 사용자의 앱 연결 해제를 시도합니다. (연결 해제 실패가 전체 탈퇴를 막지는 않음, 오류 로깅)
- **구글 계정 연동 해제**: 
  - 구글로 가입한 사용자의 경우, 서버에서 직접적인 연동 해제보다는 사용자가 Google 계정 설정에서 직접 앱 권한을 취소하도록 안내하는 방식을 따릅니다. (현재 추가적인 서버 측 자동 해제 로직 없음)
- **데이터 삭제**: 
  - 사용자 본인 계정 정보 (User DB Document)가 삭제됩니다.
  - (추후) 사용자가 작성한 게시물, 댓글 등의 데이터 처리 정책 정의 및 구현 필요.
- **프론트엔드 처리**: 
  - 탈퇴 성공 시, 로컬 토큰이 삭제되고 사용자는 로그아웃 처리되어 메인 페이지 또는 로그인 페이지로 리디렉션됩니다.

## 기술 스택
- Backend: Express.js, MongoDB
- Frontend: React.js, Material-UI
- 인증: JWT, bcrypt, Google OAuth, Kakao OAuth
- 유효성 검사: express-validator, zod

## 구현 단계

### 1단계: 백엔드 구현 [확장 완료]
- [x] 사용자 모델 정의
- [x] 회원가입 API 구현
- [x] 로그인 API 구현
- [x] JWT 미들웨어 구현
- [x] 프로필 API 구현
- [x] 이메일 인증 API 구현
- [x] 소셜 로그인 API 리팩토링 (googleLogin, kakaoLogin 공통 로직 추출)
- [x] 카카오 이메일 미제공 시 가입 완료 API 구현 (`/api/auth/kakao/complete-signup`)
- [x] 회원 탈퇴 API 구현 (`/api/auth/delete-account`)

### 2단계: 프론트엔드 구현 [확장 진행 중]
- [x] 회원가입 페이지 구현
- [x] 로그인 페이지 구현
- [x] 이메일 인증 페이지 구현
- [x] 소셜 로그인 온보딩 페이지 구현 (`/social-onboarding`)
- [x] 소셜 로그인 (Google, Kakao) 버튼 및 기본 플로우 연동
- [x] 소셜 가입 시 이메일 요청 페이지 구현 (`/social-email-request`)
- [x] 마이페이지 기본 정보 표시 (`/mypage`)
- [x] 설정 페이지 기본 UI 및 탭 (프로필 수정, 비밀번호 변경) 구현 (`/settings`)
- [x] 회원 탈퇴 기능 UI 및 기본 로직 연동 (설정 페이지)
- [x] 인증 상태 관리 구현 (AuthContext)

### 3단계: 테스트 및 보안 [진행 중]
- [ ] 단위 테스트 작성
- [ ] 통합 테스트 작성
- [x] 보안 취약점 점검
- [x] 에러 처리 보완

## API 엔드포인트

### Auth
```
POST /api/auth/register - 회원가입
POST /api/auth/login - 로그인
POST /api/auth/logout - 로그아웃
GET /api/auth/me - 현재 사용자 정보
POST /api/auth/verify-email - 이메일 인증
POST /api/auth/resend-verification - 인증 메일 재발송
POST /api/auth/google - Google 소셜 로그인/가입
POST /api/auth/kakao - Kakao 소셜 로그인/가입
POST /api/auth/kakao/complete-signup - Kakao 가입 시 이메일 입력 후 최종 완료 (신규)
POST /api/auth/delete-account - 회원 탈퇴 (신규)
```

### Profile
```
GET /api/users/:id - 사용자 프로필 조회
PUT /api/users/:id - 프로필 수정
PUT /api/users/:id/password - 비밀번호 변경
```

## 현재 진행 상황

### 해결된 사항
- 회원가입 기본 기능 구현
- 이메일 인증 메일 발송
- 인증 링크 처리
- 로그인 기능
- 기본적인 보안 설정
- 소셜 로그인 (Google, Kakao) 기본 연동
- 카카오 소셜 로그인 시 이메일 미제공 사용자 가입 플로우 구현
- 백엔드 소셜 로그인 로직 리팩토링
- 회원 탈퇴 기능 (이메일 사용자 비밀번호 확인, 카카오 연동 해제 시도, DB 사용자 삭제) 1차 구현
- 웹사이트 로그아웃 시 카카오 SDK 로그아웃 연동

### 해결 필요 사항
1. 이메일 인증 관련 401 에러
   - 문제: 회원가입 후 인증 상태 체크 시 지속적인 401 에러 발생
   - 원인 분석 중
   - 우선순위: 높음
2. 회원 탈퇴 관련 세부 사항
   - 사용자가 작성한 게시물, 댓글 등 연관 데이터 처리 정책 확정 및 구현
   - 구글 소셜 로그인 사용자의 연동 해제 관련 사용자 안내 또는 추가 조치 검토
3. (신규) Google 소셜 로그인 시 자동 로그인 현상 개선 검토

## 다음 단계
1. 이메일 인증 401 에러 해결
2. 인증 상태 관리 로직 개선
3. 회원 탈퇴 기능 상세 테스트 및 관련 데이터 처리 정책 논의/구현
4. 사용자 프로필 나머지 기능 구현 (게시물, 댓글 목록 등)
5. Google 소셜 로그인 자동 로그인 현상 개선 방안 논의 및 적용 (필요시)

## 이슈 및 해결 방안
1. 이메일 인증 후 자동 로그인 문제
   - 해결: 인증 완료 후 토큰 관리 로직 개선
2. 토큰 갱신 시 불필요한 API 호출
   - 해결: blockCheckAuthRef를 통한 API 호출 제어
3. 401 에러 처리
   - 해결: 이메일 인증이 필요한 경우 적절한 처리 로직 구현

## 예상 소요 시간
- 백엔드 구현: 2일
- 프론트엔드 구현: 2일
- 테스트 및 보안: 1일
- 총 소요 시간: 5일

## 성공 기준
- 모든 API 엔드포인트가 정상 작동
- 프론트엔드에서 원활한 사용자 경험 제공
- 보안 요구사항 충족
- 테스트 커버리지 80% 이상